<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCaml Tutor Lite</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

    <style>
        /* Custom Editor Styles to support Line Numbers */
        .editor-wrapper {
            position: relative;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.5;
            background-color: #2d2d2d;
            border-radius: 4px;
        }

        .line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            background: #1e1e1e;
            color: #858585;
            text-align: right;
            padding-right: 8px;
            padding-top: 10px; /* Match editor padding */
            user-select: none;
            overflow: hidden;
        }

        .codejar-editor {
            margin-left: 40px; /* Space for line numbers */
            padding: 10px;
            outline: none;
            color: #ccc;
            min-height: 300px;
        }

        /* Syntax colors adjustment if needed */
        .token.operator { background: none; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 h-screen flex flex-col overflow-hidden">

    <header class="h-12 border-b border-slate-700 flex items-center px-4 bg-slate-800">
        <h1 class="font-bold text-yellow-500">OCaml Tutor <span class="text-xs text-slate-400 font-normal">Lite</span></h1>
    </header>

    <div class="flex-1 flex overflow-hidden">

        <div class="w-1/3 border-r border-slate-700 p-6 overflow-y-auto bg-slate-900">
            <h2 class="text-xl font-bold mb-4 text-white">1. Hello World</h2>
            <p class="mb-4 text-slate-400">
                Welcome. Your task is to use the standard library to print a string to the output buffer.
            </p>
            <div class="bg-slate-800 p-4 rounded border border-slate-700 text-sm">
                <strong>Task:</strong> Print <code>"Hello, World!"</code>
            </div>
        </div>

        <div class="w-2/3 flex flex-col">

            <div class="flex-1 bg-[#2d2d2d] relative overflow-hidden flex flex-col">
                <div class="editor-wrapper flex-1 overflow-auto" id="editor-container">
                    <div class="line-numbers" id="line-numbers">1</div>
                    <div class="codejar-editor language-ocaml" id="editor">let () = print_endline "Hello"</div>
                </div>
            </div>

            <div class="h-12 bg-slate-800 border-t border-b border-slate-700 flex items-center justify-between px-4">
                <span class="text-xs text-slate-500" id="status">Compiler Loading...</span>
                <button id="run-btn" class="bg-green-600 hover:bg-green-500 text-white px-6 py-1 rounded text-sm font-bold opacity-50 cursor-not-allowed" disabled>
                    Run >
                </button>
            </div>

            <div class="h-1/3 bg-black p-4 font-mono text-sm overflow-auto text-green-400" id="console">
                <div class="text-slate-600 italic">Output will appear here...</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-ocaml.min.js"></script>

    <script type="module">
        import { CodeJar } from 'https://cdn.jsdelivr.net/npm/codejar@3.7.0/codejar.js';

        // --- SETUP EDITOR ---
        const editorElement = document.getElementById('editor');
        const lineNumbersElement = document.getElementById('line-numbers');

        // Highlight function for CodeJar
        const highlight = (editor) => {
            Prism.highlightElement(editor);
            updateLineNumbers(editor.textContent);
        };

        const jar = CodeJar(editorElement, highlight);

        // Simple line number updater
        function updateLineNumbers(code) {
            const lines = code.split('\n').length;
            lineNumbersElement.innerHTML = Array(lines).fill(0).map((_, i) => i + 1).join('<br>');
        }

        // Initial highlight
        highlight(editorElement);


        // --- SETUP OCAML ---
        const runBtn = document.getElementById('run-btn');
        const statusSpan = document.getElementById('status');
        const consoleDiv = document.getElementById('console');
        let ocamlReady = false;

        // Load OCaml Compiler Script dynamically
        const script = document.createElement('script');
        script.src = "https://cdn.jsdelivr.net/gh/jsoo-code-mirror/cdn@latest/toplevel.min.js";
        document.body.appendChild(script);

        // Poll for OCaml
        const checkOcaml = setInterval(() => {
            if (window.ocaml && window.ocaml.compile) {
                ocamlReady = true;
                statusSpan.textContent = "Compiler Ready";
                runBtn.disabled = false;
                runBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                clearInterval(checkOcaml);
            }
        }, 500);

        // --- RUN LOGIC ---
        runBtn.addEventListener('click', () => {
            if (!ocamlReady) return;

            const code = jar.toString();
            consoleDiv.innerHTML = ''; // Clear console

            // Capture Console Output
            const originalLog = console.log;
            const buffer = [];

            console.log = (...args) => {
                buffer.push(args.join(' '));
                // Optional: Scroll to bottom
                requestAnimationFrame(() => consoleDiv.scrollTop = consoleDiv.scrollHeight);
            };

            try {
                // Execute
                const result = window.ocaml.execute(code);
                if (result && typeof result === 'string') buffer.push(result);
            } catch (e) {
                buffer.push(`<span class="text-red-500">Error: ${e.message}</span>`);
            } finally {
                // Restore & Display
                console.log = originalLog;
                consoleDiv.innerHTML = buffer.map(line => `<div>${line}</div>`).join('');
                if (buffer.length === 0) consoleDiv.innerHTML = '<span class="text-slate-500 italic">No output returned.</span>';
            }
        });
    </script>
</body>
</html>
